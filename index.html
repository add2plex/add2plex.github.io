<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000428;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .iframe-container {
            width: 90%;
            height: 90%;
            max-width: 1200px;
            max-height: 800px;
            background: white;
            border: 2px solid #333;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="iframe-container">
        <iframe src="http://192.168.1.69:5055/" frameborder="0" id="embedFrame"></iframe>
    </div>

    <script>
        // Set XMLHttpRequest withCredentials for cross-origin requests
        (function() {
            const originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function() {
                originalOpen.apply(this, arguments);
                this.withCredentials = true;
            };
        })();

        // Set SameSite=None; Secure for cookies
        document.cookie = "SameSite=None; Secure";
        
        // Override document.cookie to add SameSite=None; Secure to all cookies
        const originalCookieDescriptor = Object.getOwnPropertyDescriptor(Document.prototype, 'cookie');
        Object.defineProperty(document, 'cookie', {
            get: function() {
                return originalCookieDescriptor.get.call(this);
            },
            set: function(val) {
                if (!val.includes('SameSite=None')) {
                    val += '; SameSite=None; Secure';
                }
                originalCookieDescriptor.set.call(this, val);
            }
        });

        const iframe = document.getElementById('embedFrame');
        let loginPopup = null;
        
        // Listen for postMessage from popup or iframe
        window.addEventListener('message', function(event) {
            // Verify origin for security (adjust if needed)
            if (event.origin !== 'http://192.168.1.69:5055') {
                return;
            }
            
            // Handle authentication success message
            if (event.data && event.data.type === 'auth_success') {
                console.log('Authentication successful, refreshing iframe...');
                iframe.src = iframe.src;
            }
            
            // Handle login complete message
            if (event.data && event.data.type === 'login_complete') {
                console.log('Login complete, refreshing iframe...');
                setTimeout(function() {
                    iframe.src = iframe.src;
                }, 500);
            }
            
            // Handle any auth token if provided
            if (event.data && event.data.token) {
                console.log('Received auth token, storing and refreshing...');
                localStorage.setItem('auth_token', event.data.token);
                iframe.src = iframe.src;
            }
        });
        
        // Monitor for popup windows
        const originalWindowOpen = window.open;
        window.open = function() {
            loginPopup = originalWindowOpen.apply(this, arguments);
            
            if (loginPopup) {
                // Check if popup is closed every 500ms
                const popupChecker = setInterval(function() {
                    if (loginPopup.closed) {
                        clearInterval(popupChecker);
                        console.log('Popup closed, refreshing iframe...');
                        // Wait a moment for cookies to settle, then refresh iframe
                        setTimeout(function() {
                            iframe.src = iframe.src;
                        }, 500);
                    }
                }, 500);
                
                // Try to send a message to the popup requesting auth status
                setTimeout(function() {
                    try {
                        loginPopup.postMessage({ type: 'request_auth' }, 'http://192.168.1.69:5055');
                    } catch (e) {
                        console.log('Could not post message to popup');
                    }
                }, 1000);
            }
            
            return loginPopup;
        };

        // Also listen for focus events
        window.addEventListener('focus', function() {
            setTimeout(function() {
                if (document.hasFocus()) {
                    console.log('Window focused, refreshing iframe...');
                    iframe.src = iframe.src;
                }
            }, 1000);
        });

        // Send message to iframe periodically to check auth status
        setInterval(function() {
            try {
                iframe.contentWindow.postMessage({ type: 'check_auth' }, 'http://192.168.1.69:5055');
            } catch (e) {
                // Cross-origin restrictions may prevent this
            }
        }, 5000);
    </script>
</body>
</html>
