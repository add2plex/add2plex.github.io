<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000428;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .iframe-container {
            width: 90%;
            height: 90%;
            max-width: 1200px;
            max-height: 800px;
            background: white;
            border: 2px solid #333;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            overflow: hidden;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="iframe-container">
        <iframe src="https://search.add2plex.com" frameborder="0" id="embedFrame"></iframe>
    </div>

    <script>
        // Set XMLHttpRequest withCredentials for cross-origin requests
        (function() {
            const originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function() {
                originalOpen.apply(this, arguments);
                this.withCredentials = true;
            };
        })();

        // Set SameSite=None; Secure for cookies
        document.cookie = "SameSite=None; Secure";
        
        // Override document.cookie to add SameSite=None; Secure to all cookies
        const originalCookieDescriptor = Object.getOwnPropertyDescriptor(Document.prototype, 'cookie');
        Object.defineProperty(document, 'cookie', {
            get: function() {
                return originalCookieDescriptor.get.call(this);
            },
            set: function(val) {
                if (!val.includes('SameSite=None')) {
                    val += '; SameSite=None; Secure';
                }
                originalCookieDescriptor.set.call(this, val);
            }
        });

        // Detect popup windows and refresh iframe when they close
        const iframe = document.getElementById('embedFrame');
        let loginPopup = null;
        
        // Monitor for popup windows
        const originalWindowOpen = window.open;
        window.open = function() {
            loginPopup = originalWindowOpen.apply(this, arguments);
            
            if (loginPopup) {
                // Check if popup is closed every 500ms
                const popupChecker = setInterval(function() {
                    if (loginPopup.closed) {
                        clearInterval(popupChecker);
                        // Wait a moment for cookies to settle, then refresh iframe
                        setTimeout(function() {
                            iframe.src = iframe.src;
                        }, 500);
                    }
                }, 500);
            }
            
            return loginPopup;
        };

        // Also listen for focus events (when user clicks back to main window)
        window.addEventListener('focus', function() {
            // Small delay to allow any authentication to complete
            setTimeout(function() {
                // Check if we should refresh (simple heuristic: if page has been visible for a bit)
                if (document.hasFocus()) {
                    iframe.src = iframe.src;
                }
            }, 1000);
        });
    </script>
</body>
</html>
